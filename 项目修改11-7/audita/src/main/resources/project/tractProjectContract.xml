<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="projecthtaudit">


   <!-- 获取跟踪项目基础信息 -->
	<select id="getTractProjectAllhtByBiaoDuanInfo" parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="com.audit.entity.project.ProejctBiaoDuanInfo">
		SELECT TOP $pagesize$ t1.id,t1.projectName,t1.projectType,t2.ownerName FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE   1 = 1  and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		and  (t.qingBiaoState ='1' or t1.projectType='1')
	    
		)
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
		AND t1.id not in(
		   SELECT TOP($pagesize$*($pageno$ - 1)) t1.id FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE 1 = 1 and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		and  (t.qingBiaoState ='1' or t1.projectType='1')
		)
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
		)
	</select>
  	
  	
  	<!-- 获取跟踪项目基础信息总数 -->
	<select id="getTractProjectAllhtByBiaoDuanInfoCount"
		parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="java.lang.Integer">
		SELECT count(1) FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE 1 = 1  and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		and  (t.qingBiaoState ='1' or t1.projectType='1')
		)
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
	</select>
	
	
	
	<!-- 获取跟踪项目下面的所有被安排的标段 -->
	<select id="findTractProjectAllhtBiaoDuanById" parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="com.audit.entity.project.ProejctBiaoDuanInfo">
		SELECT
		t.id,
		t.projectId as _parentId,
		t.biaoDuanName,
		t.projectGaiKuang,
		t.supervisorUtil,
		t.buildManageUtil,
		t.prospectUtil,
		t.buildUtil,
		t.designUtil,
		t.constructUtil,
		t.preAuditMoney,
		t.zhongBiaoMoney,
		t.reallyStartTime,
		t.buildContent,
		t.isArrange,
		t.qingBiaoState,
		t1.projectName,
		t2.ownerName,
		t3.isPay
		FROM dbo.pro_tractBiaoDuanCreate t
		LEFT JOIN
		dbo.pro_tractProjectAudit t1
		ON t.projectId = t1.id
		LEFT JOIN
		dbo.sys_projectowner t2
		ON t1.ownerId = t2.id
		LEFT JOIN
		dbo.pro_tractProjectArrange t3
		ON t3.biaoDuanId = t.Id
		LEFT JOIN 
		pro_employeeArrangeRelate t4
		on t4.projectArrangeId=t3.Id
		WHERE 1 = 1
		AND t.isArrange ='1'
		and  (t.qingBiaoState ='1' or t1.projectType='1')
		and
		t4.governmentEmployeeId=#bduserid#
		<isNotEmpty property="projectId">
			AND t.projectId = #projectId#
		</isNotEmpty>
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND ownerId = #ownerName#
		</isNotEmpty>
	</select>
	
	
		<!-- 增加合同审核条款信息 -->
	<insert id="addhtaudit"  parameterClass="com.audit.entity.project.TractProjectContract">
	   insert into pro_tractProjectContract(id,biaoDuanId,createUser,createTime,htName,htFile,existproblem,auditview,executecase,sort)
	   values
	   (#id#,#biaoDuanId#,#createUser#,#createTime#,#htName#,#htFile#,#existproblem#,#auditview#,#executecase#,#sort#)
	</insert>
	
	<!-- 修改合同审核条款信息 -->
	<update id="updatehtaudit" parameterClass="com.audit.entity.project.TractProjectContract">
	     update pro_tractProjectContract 
	     set biaoDuanId=#biaoDuanId#,
	     createUser=#createUser#,
	     createTime=#createTime#,
	     htName=#htName#,
	     htFile=#htFile#,
	     existproblem=#existproblem#,
	     auditview=#auditview#,
	     executecase=#executecase#,
	     sort=#sort#
	     where id=#id#
	</update>
	
	
	<!-- 删除合同 -->
	<delete id="deletehtaudit" parameterClass="com.audit.entity.project.TractProjectContract" >
	
	     delete from pro_tractProjectContract where biaoDuanId=#biaoDuanId# and sort>#sort#
	
	</delete>

	
	<!-- 根据标段id查询合同审核对象 -->
	<select id="selecthtbybdid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractProjectContract">
	   select * from pro_tractProjectContract  where biaoDuanId=#id# order by sort asc
	</select>
	
	<!-- 根据id查询合同审核条款对象 -->
	<select id="selecthtbyid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractProjectContract">
	select * from pro_tractProjectContract  where id=#id#
	</select>
	
</sqlMap>
