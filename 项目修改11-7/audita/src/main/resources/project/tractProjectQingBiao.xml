<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="qingbiao">


   <!-- 获取跟踪项目基础信息 -->
	<select id="getTractProjectAllqbByBiaoDuanInfo" parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="com.audit.entity.project.ProejctBiaoDuanInfo">
		SELECT TOP $pagesize$ t1.id,t1.projectName,t1.projectType,t2.ownerName FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE   1 = 1  and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		<isEqual property="qingBiaoState" compareValue="0">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="qingBiaoState" compareValue="1">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="dataTransferState" compareValue="0">
		    AND (t.dataTransferState is null OR t.dataTransferState = '0')
		</isEqual>
		<isEqual property="dataTransferState" compareValue="1">
		    AND t.dataTransferState = '1'
		</isEqual>
		<isNotEmpty property="reallyStartTime">
		    AND t.reallyStartTime <![CDATA[>=]]> #reallyStartTime#
		</isNotEmpty>
		<isNotEmpty property="reallyEndTime">
		    AND t.reallyStartTime <![CDATA[<=]]> #reallyEndTime#
		</isNotEmpty>
		)
		<isNotEmpty property="projectType">
		   AND t1.projectType = #projectType#
		</isNotEmpty>
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
		AND t1.id not in(
		   SELECT TOP($pagesize$*($pageno$ - 1)) t1.id FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE 1 = 1 and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		<isEqual property="qingBiaoState" compareValue="0">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="qingBiaoState" compareValue="1">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="dataTransferState" compareValue="0">
		    AND (t.dataTransferState is null OR t.dataTransferState = '0')
		</isEqual>
		<isEqual property="dataTransferState" compareValue="1">
		    AND t.dataTransferState = '1'
		</isEqual>
		<isNotEmpty property="reallyStartTime">
		    AND  t.reallyStartTime <![CDATA[>=]]> #reallyStartTime#
		</isNotEmpty>
		<isNotEmpty property="reallyEndTime">
		    AND t.reallyStartTime <![CDATA[<=]]> #reallyEndTime#
		</isNotEmpty>
		)
		<isNotEmpty property="projectType">
		   AND t1.projectType = #projectType#
		</isNotEmpty>
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
		)
	</select>
  	
  	
  	<!-- 获取跟踪项目基础信息总数 -->
	<select id="getTractProjectAllqbByBiaoDuanInfoCount"
		parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="java.lang.Integer">
		SELECT count(1) FROM dbo.pro_tractProjectAudit t1
		LEFT JOIN dbo.sys_projectowner
		t2
		ON t1.ownerId = t2.id
		WHERE t1.id in (SELECT distinct t.projectId FROM
		dbo.pro_tractBiaoDuanCreate t
		left join pro_tractProjectArrange a
		on t.id=a.biaoDuanId
		left join pro_employeeArrangeRelate r
		on a.id=r.projectArrangeId
		WHERE 1 = 1  
		and r.governmentEmployeeId=#bduserid#
		and  t.isArrange='1'
		<isEqual property="qingBiaoState" compareValue="0">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="qingBiaoState" compareValue="1">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="dataTransferState" compareValue="0">
		    AND (t.dataTransferState is null OR t.dataTransferState = '0')
		</isEqual>
		<isEqual property="dataTransferState" compareValue="1">
		    AND t.dataTransferState = '1'
		</isEqual>
		<isNotEmpty property="reallyStartTime">
		    AND  t.reallyStartTime <![CDATA[>=]]> #reallyStartTime#
		</isNotEmpty>
		<isNotEmpty property="reallyEndTime">
		    AND t.reallyStartTime <![CDATA[<=]]> #reallyEndTime#
		</isNotEmpty>
		)
		<isNotEmpty property="projectType">
		   AND t1.projectType = #projectType#
		</isNotEmpty>
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND t1.ownerId = #ownerName#
		</isNotEmpty>
	</select>
	
	
	
	<!-- 获取跟踪项目下面的所有被安排的标段 -->
	<select id="findTractProjectAllqbBiaoDuanById" parameterClass="com.audit.entity.project.ProejctBiaoDuanInfo"
		resultClass="com.audit.entity.project.ProejctBiaoDuanInfo">
		SELECT
		t.id,
		t.projectId as _parentId,
		t.biaoDuanName,
		t.projectGaiKuang,
		t.supervisorUtil,
		t.buildManageUtil,
		t.prospectUtil,
		t.buildUtil,
		t.designUtil,
		t.constructUtil,
		t.preAuditMoney,
		t.zhongBiaoMoney,
		t.reallyStartTime,
		t.buildContent,
		t.isArrange,
		t.qingBiaoState,
		t1.projectName,
		t2.ownerName,
		t3.isPay,
		t.dataTransferState,
		t5.username as mainAuditName
		FROM dbo.pro_tractBiaoDuanCreate t
		LEFT JOIN
		dbo.pro_tractProjectAudit t1
		ON t.projectId = t1.id
		LEFT JOIN
		dbo.sys_projectowner t2
		ON t1.ownerId = t2.id
		LEFT JOIN
		dbo.pro_tractProjectArrange t3
		ON t3.biaoDuanId = t.Id
		left join pro_employeeArrangeRelate t4
		on t3.id=t4.projectArrangeId
		LEFT JOIN dbo.sys_userinfo t5
		ON t3.mainAuditId = t5.id
		WHERE 1 = 1
		AND t.isArrange ='1'
		and t4.governmentEmployeeId=#bduserid#
		<isNotEmpty property="projectId">
			AND t.projectId = #projectId#
		</isNotEmpty>
		<isNotEmpty property="projectName">
			AND t1.projectName like
			'%$projectName$%'
		</isNotEmpty>
		<isNotEmpty property="ownerName">
			AND ownerId = #ownerName#
		</isNotEmpty>
		<isEqual property="qingBiaoState" compareValue="0">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="qingBiaoState" compareValue="1">
			AND t.qingBiaoState =
			#qingBiaoState#
		</isEqual>
		<isEqual property="dataTransferState" compareValue="0">
		    AND (t.dataTransferState is null OR t.dataTransferState = '0')
		</isEqual>
		<isEqual property="dataTransferState" compareValue="1">
		    AND t.dataTransferState = '1'
		</isEqual>
		<isNotEmpty property="reallyStartTime">
		    AND  t.reallyStartTime <![CDATA[>=]]> #reallyStartTime#
		</isNotEmpty>
		<isNotEmpty property="reallyEndTime">
		    AND t.reallyStartTime <![CDATA[<=]]> #reallyEndTime#
		</isNotEmpty>
	</select>
	
	
	<!-- 增加清标信息 -->
	<insert id="addqingbiao"  parameterClass="com.audit.entity.project.TractProjectQingBiao">
	   insert into pro_tractProjectQingBiao
	   (id,
	   biaoDuanId,
	   afterMoney,
	   createUserAccount,
	   createTime,
	   measureUtil,
	   projectCount,
	   maxUtilPrice,
	   bidUtilPrice,
	   exceedOneTwenty,
	   underEighty,
	   exceedControllerPrice,
	   underControllerPrice) 
	   values
	   (#id#,
	   #biaoDuanId#,
	   #afterMoney#,
	   #createUserAccount#,
	   #createTime#,
	   #measureUtil#,
	   #projectCount#,
	   #maxUtilPrice#,
	   #bidUtilPrice#,
	   #exceedOneTwenty#,
	   #underEighty#,
	   #exceedControllerPrice#,
	   #underControllerPrice#)
	</insert>

	<!-- 修改清标信息 updateqingbiao -->
	<update id="updateqingbiao" parameterClass="com.audit.entity.project.TractProjectQingBiao">
		update pro_tractProjectQingBiao
		set
		afterMoney=#afterMoney#,
		createUserAccount=#createUserAccount#,
		createTime=#createTime#,
		measureUtil=#measureUtil#,
		projectCount=#projectCount#,
		maxUtilPrice=#maxUtilPrice#,
		bidUtilPrice=#bidUtilPrice#,
		exceedOneTwenty=#exceedOneTwenty#,
		underEighty=#underEighty#,
		exceedControllerPrice=#exceedControllerPrice#,
		underControllerPrice=#underControllerPrice#
		where id=#id#
	</update>
	
	<!-- 根据标段id修改标段清标 -->
	<update id="updatebiaoduanqb"  parameterClass="java.lang.String">
	    update pro_tractBiaoDuanCreate set qingBiaoState='1'
	    where id=#id#
	</update>
	
	<!-- 根据标段id查询清标信息对象 -->
	<select id="selectbybdid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractProjectQingBiao">
	select * from pro_tractProjectQingBiao  where biaoDuanId=#id#
	</select>
	
	<!-- 根据id查询清标对象 -->
	<select id="selectbyid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractProjectQingBiao">
	select * from pro_tractProjectQingBiao  where id=#id#
	</select>
</sqlMap>
