<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="packProjectArrange">

	<select id="findPackProjectArrangeAllCount" parameterClass="com.audit.entity.project.PackProjectArrange"
		resultClass="java.lang.Integer">
		SELECT
		count(1)
		FROM
		(SELECT
		t1.id,t1.packageName as
		projectPackName,sum(convert(decimal(18,6),t2.sentAmount)) as
		sentAmount,SUBSTRING(CONVERT(varchar,
		t1.projectTime, 120),0,12) as
		projectTime,t3.ownerName,t1.state
		FROM
		dbo.pro_packProjectArrange t1
		LEFT
		JOIN dbo.pro_packProjectRelate t4
		ON
		t1.id = t4.projectPackId
		LEFT JOIN
		dbo.pro_datapreinfo t2
		ON
		t4.projectId = t2.id
		LEFT JOIN
		dbo.sys_projectowner t3
		ON t2.proownerid
		=
		t3.id
		WHERE 1=1
		<isNotEmpty property="ownerName">
			AND t3.ownerName like '%$ownerName$%'
		</isNotEmpty>
		<isNotEmpty property="projectPackName">
			AND t1.projectPackName like
			'%$projectPackName$%'
        </isNotEmpty>
		<isNotEmpty property="userAccount">
			AND t1.userAccount = #userAccount#
		</isNotEmpty>
		Group By t1.id,t1.packageName,t1.projectTime,t3.ownerName,t1.state) t
	</select>

	<select id="findPackProjectArrang" parameterClass="com.audit.entity.project.PackProjectArrange"
		resultClass="com.audit.entity.project.PackProjectArrange">
		SELECT TOP $pagesize$
		id,projectPackName,ownerName,sentAmount,projectTime,state
		FROM (
		SELECT
		t1.id,t1.packageName as
		projectPackName,sum(convert(decimal(18,6),t2.sentAmount)) as
		sentAmount,t1.projectTime,t3.ownerName,t1.state
		FROM
		dbo.pro_packProjectArrange t1
		LEFT JOIN dbo.pro_packProjectRelate t4
		ON
		t1.id = t4.projectPackId
		LEFT JOIN dbo.pro_datapreinfo t2
		ON
		t4.projectId = t2.id
		LEFT JOIN
		dbo.sys_projectowner t3
		ON t1.ownerId
		=
		t3.id
		WHERE 1=1
		<isNotEmpty property="ownerName">
			AND t3.ownerName like '%$ownerName$%'
		</isNotEmpty>
		<isNotEmpty property="projectPackName">
			AND t1.projectPackName like
			'%$projectPackName$%'
        </isNotEmpty>
		<isNotEmpty property="userAccount">
			AND t1.userAccount = #userAccount#
		</isNotEmpty>
		Group By t1.id,t1.packageName,t1.projectTime,t3.ownerName,t1.state
		) t1
		WHERE
		(id NOT
		IN(SELECT TOP
		($pagesize$*($pageno$ - 1)) id
		FROM
		(SELECT
		t1.id as id
		FROM
		dbo.pro_packProjectArrange t1
		LEFT JOIN dbo.pro_packProjectRelate t4
		ON
		t1.id = t4.projectPackId
		LEFT JOIN dbo.pro_datapreinfo t2
		ON
		t4.projectId = t2.id
		LEFT JOIN
		dbo.sys_projectowner t3
		ON t1.ownerId
		=
		t3.id
		WHERE 1=1
		<isNotEmpty property="ownerName">
			AND t3.ownerName like '%$ownerName$%'
		</isNotEmpty>
		<isNotEmpty property="projectPackName">
			AND t1.projectPackName like
			'%$projectPackName$%'
        </isNotEmpty>
		<isNotEmpty property="userAccount">
			AND t1.userAccount = #userAccount#
		</isNotEmpty>
		Group By t1.id,t1.packageName,t1.projectTime,t3.ownerName,t1.state
		) t4
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by projectTime desc
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by projectTime desc
	    </isEmpty>
	</select>

	<!--根据资料id查询项目安排 -->
	<select id="selectpackProjectdatapreId" parameterClass="java.lang.String"
		resultClass="com.audit.entity.project.PackProjectArrange">
		select id,intermediaryId,mainAuditId from
		pro_packProjectArrange where id
		in(select projectPackId from
		pro_packProjectRelate where
		projectId=#projectId#)
	</select>

</sqlMap>

