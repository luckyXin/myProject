<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="role">

	<typeAlias alias="role" type="com.audit.entity.Role" />
	<typeAlias alias="menu" type="com.audit.entity.Menu" />
	<select id="getRoleCount" resultClass="java.lang.Integer">
		SELECT COUNT(*) FROM
		dbo.sys_role
	</select>

	<select id="getAllTopRoleByIndexCount" parameterClass="role"
		resultClass="role">
		<![CDATA[
		SELECT TOP $pagesize$ t1.id,t1.rolename,t1.remark,t1.state,t1.createtime
		FROM (select id,rolename,remark,state,createtime from dbo.sys_role ) t1
		WHERE (id NOT IN(SELECT TOP ($pagesize$*$pageno$) id FROM
				]]>
		(select id,rolename,remark,state,createtime from dbo.sys_role) t2
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY id ASC
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY id ASC
	    </isEmpty>
	</select>

	<select id="getMaxRoleId" resultClass="java.lang.Integer">
		SELECT MAX(SUBSTRING
		(id,2,len(id)))FROM dbo.sys_role
	</select>

	<insert id="addRole" parameterClass="role">
		INSERT INTO dbo.sys_role
		(id
		,rolename
		,remark
		,state
		,createtime)
		VALUES
		(#id#
		,#rolename#
		,#remark#
		,#state#
		,GETDATE())
	</insert>

	<select id="getRoleById" parameterClass="java.lang.String"
		resultClass="role">

		SELECT id,rolename,remark,state,createtime FROM
		dbo.sys_role WHERE id = #id#
	</select>

	<select id="getRoleModuleByTopMenuId" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT t3.id FROM dbo.sys_menu t1
		Left join dbo.sys_menu t2
		ON t2.pid =
		t1.id
		Left join dbo.sys_module t3
		ON t2.id = t3.menuId
		WHERE
		t1.id =
		#topMenuId#
		AND
		t3.id <![CDATA[<>]]>
		'null'
	</select>

	<select id="getRoleModuleBySubMenuId" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT id FROM dbo.sys_module WHERE menuId = #menuId#
	</select>


	<select id="getRoleAllSubMenuByIndexCount" parameterClass="menu"
		resultClass="menu">
    <![CDATA[
		SELECT TOP $pagesize$ t1.id,t1.menuName,t1.sort,t1.state,t1.createTime,t1.remark,t1.pid
		FROM (select * from dbo.sys_menu where pid = #pid#) t1
		WHERE (id NOT IN(SELECT TOP ($pagesize$* $pageno$) id FROM
				(select * from dbo.sys_menu where pid = #pid#) t2
				]]>
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
	</select>

	<select id="checkFunctionImpowerByRole"
		parameterClass="com.audit.entity.system.CheckFunctionImpowerByRoleSqlParam"
		resultClass="java.lang.Integer">
		SELECT count(t2.functionid) FROM dbo.sys_module t1
		Left
		join dbo.sys_modulefun t2
		ON t1.id = t2.moduleid
		Left join
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		Where t1.id =
		#moduleId#
		AND t3.roleid = #roleId#
	</select>

	<select id="checkFunctionImpowerByRoleInfo"
		parameterClass="com.audit.entity.system.CheckFunctionImpowerByRoleSqlParam"
		resultClass="java.lang.String">
		SELECT t2.functionid FROM dbo.sys_module t1
		Left
		join
		dbo.sys_modulefun t2
		ON t1.id = t2.moduleid
		Left join
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		Where t1.id =
		#moduleId#
		AND t3.roleid = #roleId#
	</select>



	<select id="getNoExistModulefunInfo" parameterClass="com.audit.entity.system.RoleModuleFun"
		resultClass="java.lang.String">
		SELECT t1.id from dbo.sys_modulefun t1
		Left join
		dbo.sys_rolemodulefun
		t2 ON
		t1.id = t2.modulefunid
		WHERE t1.moduleId =
		#moduleId#
		AND t2.id is null
	</select>

	<select id="getExistModulefunInfo" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT distinct(t1.id) from dbo.sys_modulefun t1
		Left join
		dbo.sys_rolemodulefun
		t2
		ON
		t1.id = t2.modulefunid
		WHERE t1.moduleid =
		#moduleid#
		AND t2.id is not null
	</select>

	<insert id="addRoleModulefun" parameterClass="com.audit.entity.system.RoleModuleFun">
		INSERT INTO
		dbo.sys_rolemodulefun
		(id
		,roleid
		,modulefunid)
		VALUES
		((select MAX(id)+1
		from sys_rolemodulefun)
		,#roleId#
		,#modulefunid#)
	</insert>

	<delete id="deleteRoleModulefun" parameterClass="com.audit.entity.system.RoleModuleFun">
		DELETE FROM
		dbo.sys_rolemodulefun
		Where modulefunid = #modulefunid#
		AND roleid =
		#roleId#
	</delete>

	<select id="getFunctionCountByModuleid" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT count(1) FROM
		dbo.sys_modulefun Where moduleid =
		#moduleid#
	</select>

	<select id="getAllSubMenuCount" resultClass="java.lang.Integer">
		SELECT COUNT(*) FROM
		dbo.sys_menu WHERE pid <![CDATA[<>]]>'0'
	</select>

	<select id="getModuleCountBySubMenu" parameterClass="com.audit.entity.system.ModuleParam"
		resultClass="java.lang.Integer">
		SELECT count(1)
		FROM sys_module t1
		where t1.menuId =
		#menuId#
	</select>

	<!-- 分页查询 -->
	<select id="getModuleByIndexCountBySubMenuId" parameterClass="com.audit.entity.system.ModuleParam"
		resultClass="com.audit.entity.system.ModuleResult">
		SELECT top $pagesize$ moduleId,
		moduleName ,
		menuId,
		menuName,
		remark,
		state,
		url
		FROM (select
		t1.id as moduleId,
		t1.moduleName as moduleName,
		t1.state as state,
		t1.menuId as menuId,
		t2.menuName as menuName ,
		t1.remark as remark,
		t1.url as url
		FROM sys_module t1
		LEFT JOIN
		dbo.sys_menu t2
		ON t1.menuId = t2.id
		where 1=1
		AND menuId = #menuId#
		<isNotEmpty prepend="AND" property="moduleName">
			modulename like
			'%$moduleName$%'
		      </isNotEmpty>
		) t3
		WHERE (moduleId NOT IN(
		select top <![CDATA[($pagesize$* $pageno$)]]>
		t1.id as moduleId
		FROM sys_module t1
		LEFT JOIN dbo.sys_menu t2
		ON
		t1.menuId = t2.id
		where 1=1
		AND menuId = #menuId#
		<isNotEmpty prepend="AND" property="moduleName">
			modulename like
			'%$moduleName$%'
		      </isNotEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
	          </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by moduleId asc
		      </isEmpty>
	</select>

	<select id="getFunctionByIndexCountByMenuId" parameterClass="function"
		resultClass="function">

		SELECT TOP $pagesize$
		t1.id,t1.name,t1.method,t1.icon,t1.state,t1.createTime,t1.remark
		FROM
		(SELECT
		t3.id,t3.name,t3.method,t3.icon,t3.state,t3.createTime,t3.remark FROM
		dbo.sys_function t3
		left Join dbo.sys_modulefun t4
		ON t3.id =
		t4.functionid
		left Join dbo.sys_module t5
		ON t4.moduleid = t5.id
		Where
		t5.id = #moduleid#
		) t1
<![CDATA[
		WHERE (id NOT IN(SELECT TOP ($pagesize$* $pageno$) id FROM
		]]>
		(SELECT
		t3.id,t3.name,t3.method,t3.icon,t3.state,t3.createTime,t3.remark FROM
		dbo.sys_function t3
		left Join dbo.sys_modulefun t4
		ON t3.id =
		t4.functionid
		left Join dbo.sys_module t5
		ON t4.moduleid = t5.id
		Where
		t5.id = #moduleid#
		) t2
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY id ASC
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY id ASC
	    </isEmpty>
	</select>

	<select id="checkFunctionExist" parameterClass="com.audit.entity.ModuleFun"
		resultClass="java.lang.String">
		SELECT t1.id from dbo.sys_modulefun t1
		WHERE t1.moduleid =
		#moduleId#
		AND
		t1.functionid = #functionId#
	</select>

	<update id="updateRoleInfo" parameterClass="com.audit.entity.Role">
		UPDATE dbo.sys_role
		SET
		createtime = GETDATE()
		<isNotNull property="rolename">
			,rolename = #rolename#
		</isNotNull>
		,remark = #remark#
		<isNotNull property="state">
			,state = #state#
		</isNotNull>
		WHERE id = #id#
	</update>

	<update id="destroyRole" parameterClass="com.audit.entity.Role">
		UPDATE dbo.sys_role
		SET
		createtime = GETDATE()
		,state = #state#
		WHERE id = #id#
	</update>

	<delete id="deleteRole" parameterClass="java.lang.String">
		DELETE FROM dbo.sys_role
		WHERE id=#id#
	</delete>

	<delete id="deleteRMF" parameterClass="java.lang.String">
		DELETE FROM
		dbo.sys_rolemodulefun
		WHERE roleid=#id#
	</delete>

	<delete id="deleteRU" parameterClass="java.lang.String">
		DELETE FROM
		dbo.sys_roleuser
		WHERE roleid=#id#
	</delete>

	<select id="noExistModulefunInfo" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT distinct(t1.id) from dbo.sys_modulefun t1
		Left join
		dbo.sys_rolemodulefun
		t2
		ON
		t1.id = t2.modulefunid
		WHERE t1.moduleid =
		#moduleid#
	</select>

	<select id="getNoexistMFS" parameterClass="com.audit.entity.system.ModuleFunctionRoleParam"
		resultClass="java.lang.String">
		select t1.id from dbo.sys_modulefun t1 where t1.moduleid =
		#moduleId# AND t1.id not in (
		SELECT t1.id from dbo.sys_modulefun t1
		Left join
		dbo.sys_rolemodulefun t2
		ON
		t1.id = t2.modulefunid
		WHERE
		t1.moduleid =
		#moduleId#
		AND t2.roleid =
		#roleId#
		)
	</select>

	<!-- 查询该角色拥有的权限总数 -->
	<select id="getAreadyHaveSubMenuImpowerCount" parameterClass="com.audit.entity.Role"
		resultClass="java.lang.Integer">
		SELECT
		count(1) FROM (
		SELECT distinct t4.id as
		menuId,t4.menuName as
		menuName,t4.state as
		menuState,t4.remark as
		remark,t4.pid as _parentId
		FROM dbo.sys_module t1
		LEFT JOIN
		dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		LEFT
		JOIN dbo.sys_menu
		t4
		ON t1.menuId = t4.id
		WHERE t3.roleid = #id#
		) t
	</select>

	<!-- 查询该角色拥有权限 -->
	<select id="getAreadyHaveSubMenuImpower" parameterClass="com.audit.entity.Role"
		resultClass="com.audit.entity.system.TreeMenuResult">
		SELECT TOP $pagesize$
		menuId,menuName,menuState,remark FROM (
		SELECT distinct t4.id as menuId,t4.menuName as
		menuName,t4.state as
		menuState,t4.remark as remark
		FROM dbo.sys_module t1
		LEFT JOIN dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		LEFT
		JOIN dbo.sys_menu
		t4
		ON t1.menuId = t4.id
		WHERE t3.roleid = #id#
		) t
		WHERE menuId not in (
		SELECT TOP($pagesize$* ($pageno$ - 1))
		menuId FROM
		(
		SELECT distinct
		t4.id as
		menuId,t4.menuName as
		menuName,t4.state as
		menuState,t4.remark
		as
		remark
		FROM dbo.sys_module t1
		LEFT JOIN
		dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		LEFT
		JOIN dbo.sys_menu
		t4
		ON t1.menuId = t4.id
		WHERE t3.roleid = #id#
		) t
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY menuId ASC
	    </isEmpty>
		)
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			ORDER BY menuId ASC
	    </isEmpty>
	</select>


	<!-- 查询该角色拥有的权限总数 -->
	<select id="getAreadyHaveModuleImpowerCount" parameterClass="com.audit.entity.Role"
		resultClass="java.lang.Integer">
		SELECT
		count(1) FROM (
		SELECT distinct t1.id as
		menuId,t1.modulename as
		menuName,t1.state as
		menuState,t1.remark as
		remark,t1.menuId as _parentId
		FROM dbo.sys_module t1
		LEFT JOIN
		dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		WHERE
		t3.roleid =
		#id#
		AND
		t1.menuId = #menuId#
		) t
	</select>

	<!-- 查询该角色拥有权限 -->
	<select id="getAreadyHaveModuleImpower" parameterClass="com.audit.entity.Role"
		resultClass="com.audit.entity.system.TreeMenuResult">
		SELECT distinct t1.id as
		menuId,t1.modulename as
		menuName,t1.state as
		menuState,t1.remark as
		remark,t1.menuId as _parentId
		FROM dbo.sys_module
		t1
		LEFT JOIN
		dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		WHERE
		t3.roleid =
		#id#
		AND
		t1.menuId = #menuId#
	</select>

	<!-- 查询该角色拥有的权限总数 -->
	<select id="getAreadyHaveFunctionImpowerCount" parameterClass="com.audit.entity.Role"
		resultClass="java.lang.Integer">
		SELECT
		count(1) FROM (
		SELECT distinct t4.id as
		menuId,t4.name as menuName,t4.state as
		menuState,t4.remark as
		remark,t1.id as _parentId
		FROM dbo.sys_module t1
		LEFT JOIN
		dbo.sys_modulefun t2
		ON t2.moduleid = t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		LEFT JOIN
		dbo.sys_function t4
		ON t4.id = t2.functionid
		WHERE t3.roleid = #id#
		AND
		t1.id = #menuId#
		) t
	</select>

	<!-- 查询该角色拥有权限 -->
	<select id="getAreadyHaveFunctionImpower" parameterClass="com.audit.entity.Role"
		resultClass="com.audit.entity.system.TreeMenuResult">
		SELECT distinct t4.id as menuId,t4.name as
		menuName,t4.state as
		menuState,t4.remark as remark,t1.id as _parentId
		FROM dbo.sys_module t1
		LEFT JOIN dbo.sys_modulefun t2
		ON t2.moduleid =
		t1.id
		LEFT JOIN
		dbo.sys_rolemodulefun t3
		ON t2.id = t3.modulefunid
		LEFT
		JOIN
		dbo.sys_function t4
		ON t4.id = t2.functionid
		WHERE t3.roleid = #id#
		AND
		t1.id = #menuId#
	</select>

</sqlMap>
