<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="tractCommonExcelXml">
   
   <!-- 查询该用户所有的标段信息 -->
   <select id="selectbiaoduanbyuserid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractArrangeProjectInfo">
	   select biaoDuanId  from pro_tractProjectArrange where id in(select projectArrangeId from pro_employeeArrangeRelate where governmentEmployeeId=#id#)
   </select>
	  
	 <!-- 根据标段查询所有的月份 --> 
	<select id="selectmonthbybdid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractMonthReportInfo">
	   select createTime from pro_tractMonthContent where biaoDuanId=#id#
   </select>
   
   <!-- 根据年月查询标段信息 -->
	<select id="selectbiaoduanbytime" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractMonthReportInfo">
	   select biaoDuanId  from pro_tractMonthContent  where substring(convert(varchar(20),createTime,120),1,7)=#id#
   </select>
   
   <!-- 根据标段和时间查询最新时间的月报信息 -->
	<select id="selectmonthinfobybdtime" parameterClass="com.audit.entity.project.TractMonthReportInfo" resultClass="com.audit.entity.project.TractMonthReportInfo">
	  SELECT * FROM dbo.pro_tractMonthContent t
       WHERE t.biaoDuanId = #biaoDuanId#
       AND t.createTime = (SELECT MAX(createTime) FROM dbo.pro_tractMonthContent t WHERE t.biaoDuanId = #biaoDuanId#
      AND substring(convert(varchar(20),t.createTime,120),1,7) =#createTime#) 
   </select>
   
   
   <!-- 查询变更后总金额 -->
   <select id="selectTractChangeCardInfoById" parameterClass="com.audit.entity.project.TractProjectChangeCardInfo" resultClass="com.audit.entity.project.TractProjectChangeCardInfo">
      SELECT sum(convert(decimal(18,2),t.affirmChangeMoney)) as totalMoney FROM
		dbo.pro_tractProjectChangeCode t
		WHERE t.biaoDuanId = #biaoDuanId#
		and substring(convert(varchar(20),t.changeTime,120),1,7)=#changeTime#
       <isNotEmpty property="changeType">
			AND t.changeType = #changeType#
		</isNotEmpty>
   </select>
   
   
   <!-- 查询人工和材料的总价 -->
    <select id="selectTractPolicyChangeInfo" parameterClass="com.audit.entity.project.TractPolicyChange" resultClass="com.audit.entity.project.TractPolicyChange">
     SELECT sum(convert(decimal(18,2),t.artificialfile)) as artificialfile,sum(convert(decimal(18,2),t.datamoney)) as datamoney FROM
		dbo.pro_tractPolicyChange t
		WHERE t.biaoDuanId = #biaoDuanId#
		and substring(convert(varchar(20),t.createTime,120),1,7)=#createTime#
   </select>
   
   
   <!-- 跟踪标段查询清标后金额 -->
    <select id="selectqingbiaomoneybybdid" parameterClass="java.lang.String" resultClass="com.audit.entity.project.TractProjectQingBiao">
       select afterMoney from pro_tractProjectQingBiao where biaoDuanId=#id#
   </select>
   
   
   
   
</sqlMap>
