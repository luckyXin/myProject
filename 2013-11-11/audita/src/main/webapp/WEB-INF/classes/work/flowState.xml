<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap 
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="flowState">

	<select id="getFindAuditStateCount" resultClass="java.lang.Integer">
		SELECT count(1)
		FROM dbo.sys_auditStateInfo
	</select>

	<select id="findAuditStateInfo" parameterClass="com.audit.entity.work.AuditState"
		resultClass="com.audit.entity.work.AuditState">
		SELECT TOP $pagesize$ id,name,value,module FROM (SELECT
		id,name,value,module FROM dbo.sys_auditStateInfo) t1
		WHERE (id NOT
		IN(SELECT TOP ($pagesize$*$pageno$) id FROM (SELECT
		id,name,value,module FROM dbo.sys_auditStateInfo) t2
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
	</select>

	<select id="getNoCompeleteWorkAllCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT count(1) FROM
		dbo.sys_flowInfo t1
		LEFT
		JOIN
		dbo.sys_flowStateInfo t2
		ON t1.id =
		t2.flowId
		LEFT JOIN
		dbo.sys_auditStateInfo t3
		ON t2.stateId = t3.id
		LEFT
		JOIN dbo.sys_module
		t4
		ON t3.module = t4.id
		WHERE
		t2.id in (SELECT
		flowStateId FROM
		dbo.sys_flowStateUserInfo WHERE
		userAccount = #userAccount#)
	</select>

	<select id="getNoCompeleteWork" parameterClass="com.audit.entity.work.MyNoCompleteWorkInfo"
		resultClass="com.audit.entity.work.MyNoCompleteWorkInfo">
		SELECT TOP $pagesize$
		id,moduleId,moduleName,mouduleUrl,projectId,stateId,stateName,functionName
		FROM (SELECT t1.id as id,t3.module as moduleId,t4.moduleName as
		moduleName,t4.url as mouduleUrl,
		t1.projectDateId as projectId,t3.id as
		stateId,t3.name as stateName,t3.functionName
		as functionName FROM
		dbo.sys_flowInfo t1
		LEFT JOIN dbo.sys_flowStateInfo t2
		ON t1.id =
		t2.flowId
		LEFT JOIN dbo.sys_auditStateInfo t3
		ON t2.stateId = t3.id
		LEFT
		JOIN dbo.sys_module t4
		ON t3.module = t4.id
		WHERE
		t2.id in (SELECT
		flowStateId FROM dbo.sys_flowStateUserInfo WHERE
		userAccount =
		#userAccount#)) t1
		WHERE (id not in(
		SELECT TOP
		($pagesize$*($pageno$-1)) t1.id FROM
		dbo.sys_flowInfo t1
		LEFT JOIN
		dbo.sys_flowStateInfo t2
		ON t1.id =
		t2.flowId
		LEFT JOIN
		dbo.sys_auditStateInfo t3
		ON t2.stateId = t3.id
		LEFT
		JOIN dbo.sys_module
		t4
		ON t3.module = t4.id
		WHERE
		t2.id in (SELECT
		flowStateId FROM
		dbo.sys_flowStateUserInfo WHERE
		userAccount = #userAccount#)
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
		))
		<dynamic prepend="order by">
			<isNotEmpty property="filed">
				$filed$ $sort$
             </isNotEmpty>
		</dynamic>
		<isEmpty property="filed">
			order by id asc
	    </isEmpty>
	</select>

	<select id="selectDatapreinfoName" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT projectName FROM dbo.pro_datapreinfo WHERE id =
		#id#
	</select>

	<select id="selectSingleProjectName" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT t2.projectName FROM dbo.pro_singleProjectArrange t1
		LEFT JOIN dbo.pro_datapreinfo t2
		ON t1.datapreId = t2.id
		WHERE t1.id =
		#id#
	</select>

	<select id="selectPackProjectArrangeName" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT packageName FROM dbo.pro_packProjectArrange WHERE
		id =
		#id#
	</select>

	<select id="selectWorkNoCompleteSimple" parameterClass="java.lang.String"
		resultClass="com.audit.entity.work.WorkInfo">
		SELECT t3.name as stateName,t3.moduleName,COUNT(1) as
		count,t4.url,t3.module as moduleId FROM
		dbo.sys_flowInfo t1
		LEFT JOIN
		dbo.sys_flowStateInfo t2
		ON t1.id =
		t2.flowId
		LEFT JOIN
		dbo.sys_auditStateInfo t3
		ON t2.stateId = t3.id
		LEFT
		JOIN dbo.sys_module
		t4 ON t3.module = t4.id WHERE t2.id in (SELECT
		flowStateId FROM
		dbo.sys_flowStateUserInfo WHERE
		userAccount =
		#userAccount#)
		AND t1.state = '0'
		GROUP BY
		t3.name,t3.moduleName,t4.url,t3.module
	</select>

	<select id="selectWorkNoCompleteSimpleByArrange" parameterClass="java.lang.String"
		resultClass="com.audit.entity.work.WorkInfo">
		SELECT stateName,moduleName,count(1) as
		count,url,moduleId
		FROM (
		SELECT
		t.id,
		t3.name as stateName,
		t3.moduleName,
		COUNT(1) as count,
		t4.url,
		t3.module as
		moduleId
		FROM dbo.pro_singleProjectArrange t
		LEFT
		JOIN dbo.sys_flowInfo
		t1
		ON
		t.datapreId = t1.projectDateId
		LEFT JOIN
		dbo.sys_flowStateInfo t2
		ON
		t1.id =
		t2.flowId
		LEFT JOIN
		dbo.sys_auditStateInfo t3
		ON t2.stateId =
		t3.id
		LEFT
		JOIN dbo.sys_module
		t4 ON t3.module = t4.id WHERE 
		t2.id in
		(SELECT
		flowStateId FROM
		dbo.sys_flowStateUserInfo WHERE
		userAccount =
		#userAccount#)
		AND t1.state = '0'
		GROUP BY
		t.id,t3.name,t3.moduleName,t4.url,t3.module
		union
		SELECT
		tb.id,
		t3.name as
		stateName,
		t3.moduleName,
		COUNT(1) as count,
		t4.url,
		t3.module as moduleId
		FROM dbo.pro_packProjectArrange tb
		LEFT
		JOIN
		dbo.pro_packProjectRelate ta
		On ta.projectPackId = tb.id
		LEFT JOIN
		dbo.sys_flowInfo t1
		ON ta.projectId
		= t1.projectDateId
		LEFT JOIN
		dbo.sys_flowStateInfo t2
		ON t1.id =
		t2.flowId
		LEFT JOIN
		dbo.sys_auditStateInfo t3
		ON t2.stateId = t3.id
		LEFT
		JOIN dbo.sys_module
		t4 ON t3.module = t4.id 
		WHERE t2.id in 
		(SELECT
		flowStateId FROM
		dbo.sys_flowStateUserInfo WHERE
		userAccount = #userAccount#
		)
		AND t1.state = '0'
		GROUP BY
		t3.name,t3.moduleName,t4.url,t3.module,tb.id
		) t
		GROUP BY
		stateName,moduleName,url,moduleId
	</select>

	<select id="selectWorkCompleteSimple" parameterClass="java.lang.String"
		resultClass="com.audit.entity.work.WorkInfo">
		SELECT moduleName,count(1) as count,url,updateTime as
		workTime,moduleId FROM
		(
		SELECT distinct
		t2.moduleName,t3.url,SUBSTRING(CONVERT(varchar, t1.updateTime,
		120),0,12) as
		updateTime,t2.module as moduleId,t1.projectDateId as
		projectDateId FROM dbo.sys_flowRecord t1
		LEFT JOIN
		dbo.sys_auditStateInfo t2
		ON t1.beforeState = t2.value
		LEFT JOIN
		dbo.sys_module t3
		ON t2.module = t3.id
		WHERE
		t1.userAccount=#userAccount#
		GROUP BY
		t2.moduleName,t1.projectDateId,t1.beforeState,t3.url,updateTime,t2.module
		HAVING t1.beforeState is not null AND t1.beforeState <![CDATA[<>]]>
		'' AND t2.moduleName is not null) t1
		GROUP BY
		updateTime,moduleName,url,moduleId
		Order by updateTime desc
	</select>

	<select id="selectWorkCompleteSimpleByArrange" parameterClass="java.lang.String"
		resultClass="com.audit.entity.work.WorkInfo">
		SELECT moduleName,count(1) as count,url,updateTime as
		workTime,moduleId
		FROM (
		SELECT distinct
		t.id,t2.moduleName,t3.url,SUBSTRING(CONVERT(varchar,
		t1.updateTime,
		120),0,12) as updateTime,t2.module as moduleId
		FROM
		dbo.pro_singleProjectArrange t
		LEFT JOIN dbo.sys_flowRecord t1
		ON
		t1.projectDateId = t.datapreId
		LEFT JOIN dbo.sys_auditStateInfo t2
		ON
		t1.beforeState = t2.value
		LEFT JOIN dbo.sys_module t3
		ON t2.module =
		t3.id
		WHERE t1.userAccount=#userAccount#
		GROUP BY
		t2.moduleName,t.id,t1.beforeState,t3.url,updateTime,t2.module
		Having
		t.id is not null
		union
		SELECT distinct tb.id,
		t2.moduleName,t3.url,SUBSTRING(CONVERT(varchar,
		t1.updateTime,
		120),0,12)
		as updateTime,t2.module as moduleId
		FROM
		dbo.pro_packProjectArrange tb
		LEFT JOIN dbo.pro_packProjectRelate ta
		On
		ta.projectPackId = tb.id
		LEFT JOIN dbo.sys_flowRecord t1
		ON
		t1.projectDateId = ta.projectId
		LEFT JOIN dbo.sys_auditStateInfo t2
		ON
		t1.beforeState = t2.value
		LEFT JOIN dbo.sys_module t3 ON t2.module =
		t3.id
		WHERE t1.userAccount=#userAccount#
		GROUP BY tb.id,
		t2.moduleName,t1.beforeState,t3.url,updateTime,t2.module
		Having tb.id
		is not null
		) t
		GROUP BY
		updateTime,moduleName,url,moduleId
		Order by
		workTime desc
	</select>

	<delete id="deleteFlowStateSingleUserAccount" parameterClass="com.audit.entity.FlowStateUserAccount">
		DELETE FROM dbo.sys_flowStateUserInfo
		WHERE flowStateId = #flowStateId# AND userAccount = #userAccount#
	</delete>
	
	<select id="checkIsMySelfAuditProject" parameterClass="java.lang.String" 
	resultClass="java.lang.Integer">
	SELECT COUNT(1) FROM (
	SELECT t1.id FROM dbo.pro_packProjectArrange t1
	LEFT JOIN dbo.pro_packProjectRelate t2
	ON t1.id = t2.projectPackId
	WHERE t2.projectId = #id#
	AND
	t1.isMySelfState = '1'
	union
	SELECT t1.id FROM dbo.pro_singleProjectArrange t1
	WHERE t1.datapreId = #id#
	AND t1.isMySelfState = '1'
	) t
	</select>
</sqlMap>

